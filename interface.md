# 接口记录

我们在这个文件中记录所有的接口。

## url接口

url接口用于前端调用，通常是对一些功能的打包整理，以及维护整个流程进行。

### 状态码列表

大部分url接口都会返回status。这里维护了所有status作为状态码。

- `0` 成功.
- `100` 未知的参数错误.
- `101` 缺少参数.
- `102` 参数格式不正确.
- `103` position必须是1-25之间的整数.
- `200` 未知的逻辑错误.
- `201` 秘境ID不存在.
- `202` 团长权限验证失败.
- `203` 成员权限验证失败.
- `204` 地图验证失败.
- `205` BOSS名称验证失败.
- `206` 角色名已经被注册，请换一个角色名.
- `207` 位置已经被占用，请换一个位置.
- `300` 未知的结果错误.
- `301` 结果为空.

### 创建秘境：/createDungeon

不需要权限。
创建一个秘境，并得到其编号和管理员权限。只有创建过的秘境才能实现功能。

参数：

- `map` 地图。必须是`25人普通西津渡`或者`25人英雄西津渡`。

返回：

- `status` 操作状态。
- `DungeonID` 秘境的编号。绝大多数秘境操作都需要在这个编号的基础上进行。
- `AdminToken` 团长令牌。部分需要管理员权限的操作需要这个令牌才有效。

### 加入团队：/registerTeam

不需要权限。
作为团队成员在秘境中进行登记，并得到成员权限。成员权限只需要提供自己的游戏角色名即可。

参数：

- `DungeonID` 秘境的编号。
- `playerName` 角色名。同时也是成员权限的来源。
- `xinfa` 心法。用于后续拍卖过程中辅助筛选。
- `position` 位置（应该是1-25之间）。用于标识团队面板中的位置。

返回：

- `status` 操作状态。

### 展示团队：/getTeam

不需要权限。
展示团队表。用于显示团队中还有谁没有登记。

参数：

- `DungeonID` 秘境的编号。

返回：

- `status` 操作状态。
- `team` 团队面板列表。列表格式。
    - `position` 位置（应该是1-25之间）。
    - `playerName` 玩家名。如果为空就代表这个位置还没有等级。
    - `xinfa` 心法。
    - `profile` 当前展示的状态。可以表示“思考中”“拍完了”等状态。

### (TODO)上传掉落：/setTreasure

需要管理员权限。
上传单个BOSS的掉落，并记录。

参数：

- `AdminToken` 团长令牌。需要进行验证。
- `DungeonID` 秘境的编号。需要进行验证。
- `boss` BOSS名称。必须是`张景超`、`刘展`、`苏凤楼`、`韩敬青`、`藤原佑野`、`李重茂`中的一个。
- `treasure` 掉落列表。用游戏中复制来的字符串格式，形如`[清蕊坠][揽江护腕·万花][五行石（六级）]`。

返回：

- `status` 操作状态。

### (TODO)获取掉落：/getTreasure

需要成员权限。
获取秘境中所有BOSS的掉落情况。

参数：

- `playerName` 角色名。需要进行验证。
- `DungeonID` 秘境的编号。需要进行验证。

返回：

- `status` 操作状态。
- `treasure` 掉落列表，数组格式。每条具有如下属性：
    - `itemID` 物品ID。这对应了BOSS掉落的每个物品，并非游戏中的ID。
    - `property` 属性列表。是logic.ItemAnalyser.GetGroupItemByName中的返回结果。

### (TODO)开始拍卖：/startAuction

需要管理员权限。
在收集所有掉落后，开始拍卖流程。（暂时的逻辑）在开始拍卖后不能上传新的掉落。

参数：

- `AdminToken` 团长令牌。需要进行验证。
- `DungeonID` 秘境的编号。需要进行验证。
- XXX(TODO) 拍卖的所有详细设定都需要在这一步完成。

返回：

- `status` 操作状态。

### (TODO)获取拍卖：/getAuction

需要成员权限。
获取拍卖的完整信息。这个流程只应该在第一次进入拍卖、或者断线重连时使用。
在正常拍卖流程中应当尝试使用websocket接口去获取拍卖的增量变化。

参数：

- `playerName` 角色名。需要进行验证。
- `DungeonID` 秘境的编号。需要进行验证。

返回：

- `status` 操作状态。
- `treasure` 掉落列表，数组格式。每条具有如下属性：
    - `itemID` 物品ID。这对应了BOSS掉落的每个物品，并非游戏中的ID。
    - `boss` 对应的BOSS。
    - `property` 属性列表。是logic.ItemAnalyser.GetGroupItemByName中的返回结果。
    - `bids` 出价列表。数组格式，记录玩家名，价格，出价时间。保证按照时间倒序排列。
    - `currentPrice` 当前出价。数组格式（用于兼容同步拍卖）。如果为空则代表无人出价。
    - `currentOwner` 当前出价的拥有者。数组格式（用于兼容同步拍卖）。如果为空则代表无人出价。
    - `basePrice` 起拍价。预先在规则中指定。
    - `minimalStep` 最小加价。预先在规则中指定。
    - `groupID` 打包拍卖的主元素ID。如果为-1表示不是打包拍卖。
    - `simulID` 同步拍卖的主元素ID。如果为-1表示不是同步拍卖。
    - `autobid` **自己的**自动出价的P价。如果为-1表示不自动出价。
  
### (TODO)出价：/bid

需要成员权限。
尝试对一个物品进行出价。
如果这个物品处于打包或者同步状态，那么后台会计算出价的结果。

参数：

- `playerName` 角色名。需要进行验证。
- `DungeonID` 秘境的编号。需要进行验证。
- `itemID` 物品ID。
- `price` 价格。

返回：

- `status` 操作状态。

### (TODO)自动出价：/autobid

需要成员权限。
尝试对一个物品进行自动出价。相当于为物品提供P价，并在达到P价之前不断以最小间隔进行出价。
如果这个物品处于打包或者同步状态，那么后台会计算出价的结果。

参数：

- `playerName` 角色名。需要进行验证。
- `DungeonID` 秘境的编号。需要进行验证。
- `itemID` 物品ID。
- `price` 价格。如果为-1，那么表示取消自动出价。
- `num`  需求的数量，用于同步出价。

返回：

- `status` 操作状态。

### (TODO)结束拍卖：/stopAuction

需要管理员权限。
结束拍卖流程并开启账单展示。

参数：

- `AdminToken` 团长令牌。需要进行验证。
- `DungeonID` 秘境的编号。需要进行验证。

返回：

- `status` 操作状态。

### (TODO)展示账单：/checkout

不需要权限。
展示拍卖结果。

参数：

- `DungeonID` 秘境的编号。需要进行验证。

返回：

- `status` 操作状态。
- `bill` 账单。包括所有物品和
  - `treasure` 掉落列表，数组格式。每条具有如下属性：
      - `itemID` 物品ID。这对应了BOSS掉落的每个物品，并非游戏中的ID。
      - `boss` 对应的BOSS。
      - `currentPrice` 出价结果。
      - `currentOwner` 出价对应的玩家。
  - `team` 团队面板列表。数组格式。尽量按`cost`逆序排列。
      - `position` 位置（应该是1-25之间）。
      - `playerName` 玩家名。
      - `xinfa` 心法。
      - `cost` 总消费。 
  
### (TODO)还应该有一堆后悔药功能、防捣乱功能，在以后的版本中再实现吧。

## python方法

python方法为后端方法，不对外开放，用于各个模块之间的协调。

### 掉落获取：logic.ItemAnalyser.GetSingleItemByName

通过输入掉落的名称，可以获取所有需要进行展示的信息。副本名用于辅助判断一些重名情况。
如果提供心法名，还可以显示对应的兑换类装备在兑换之后的结果。

输入：

- `name` 装备名。例如`肆级五彩石`。
- `map` 副本名。例如`25人英雄西津渡`。
- `xinfa` 心法。例如`冰心诀`。用于实现兑换牌的展示。

输出：
- `available` 是否可用。必定出现。1表示可用，0表示不可用。如果为0，那么接下来的所有属性都不会出现。
- `name` 与输入相同。但如果有别名，那么返回标准命名。
- `icon` 图标ID。
- `quality` 物品的品质，白/绿/蓝/紫/橙。
- `desc` 物品的描述，用一个数组类型记录所有的描述。每个描述又分为两个部分，其一为文本，其二为颜色。
- `type` 物品的种类。包括以下几种取值：
    - `equipment` 装备
    - `coupon` 兑换牌，包括门派套装牌子和武器盒子
    - `item` 非装备类型
- `related` 对兑换牌类的补充，包含其可以换到的装备名，数组格式。（注意在GetGroupItemByName中会被替换）
- `class` 对兑换牌/非装备类型的进一步细分，主要用于打包拍卖的场景，包括以下种类
    - `coupon` 兑换牌
    - `materials` 包括五行石、五彩石、生活技能材料
    - `enchant` 包括强化附魔，主要是吃鸡附魔、大附魔（将这些单列出来是由于心法适配的需求）
    - `character` 包括侠客的低阶掉落物品，主要是茶饼、维峰丹
    - `xiaotie` 包括小铁
    - `datie` 包括大铁（这玩意真的会有？）
    - `special` 包括副本的特殊掉落，主要是各种挂件。
    - `hanzi` 包括剑侠情缘汉字，在活动期间会出现。
    - `other` 包括不在上面分类中的其它内容。常见的有：侠客秘籍、挂件等特殊掉落。
- `attribute` 只在装备或兑换牌类型中出现。其内部也是一个pythondict，包括：
    - `base` 白字属性，数组格式，用文字字符串描述。
    - `extra` 绿字属性，数组格式，用文字字符串描述。
    - `plug` 镶嵌栏属性，数组格式，用文字字符串描述。
    - `suit` 套装属性，数组格式，用文字字符串描述。
    - `special` 特效属性，数组格式，用文字字符串描述。
- `subtype` 装备的子分类，如项链、腰带
- `level` 装备的品级。
- `main` 主属性。包括`力道`*4，`防御`，`治疗`，`内功`/`外功`（用于精简)，`武器`，`套装`。
- `school` 装备的门派。用于在`main`为`套装`或`武器`时区分其适用范围。这个属性在`coupon`类型中也会出现。
- `sketch` 属性简述，包括`会心`、`纯疗`、`招架`等。
  
- 完成情况：治疗心法首饰1、防具1、武器1；输出心法1；防御心法1；特效腰坠1、特效武器1；sketch重写1；精简1；牌子1、武器盒子1；明教1；种类1、部位优化1；文字优化1；
- 物品对齐：五行石1、五彩石1、玛瑙1、附魔1、茶饼1、小铁1、大铁1、挂件1、汉字1、秘籍1、牌子1、武器盒1、藏剑武器1


### (TODO)掉落获取：logic.ItemAnalyser.GetGroupItemByName

通过输入BOSS掉落的字符串，获取所有需要进行展示的信息。副本名用于辅助判断一些重名情况。
如果提供心法名，还可以显示对应的兑换类装备在兑换之后的结果。
注意，从游戏中复制的字符串需要用另外的操作转化成数组。这个方法只用来向用户展示，但不进数据库。

输入：

- `name` 掉落列表，数组格式，例如`["肆级五彩石", "玛瑙"]`。
- `map` 副本名。例如`25人英雄西津渡`。
- `xinfa` 心法。例如`冰心诀`。用于实现兑换牌的展示。

输出：

- `result` 数组格式，大部分与调用GetSingleItemByName的结果相同.
    - `related` 这里不再是字符串，而是再次调用GetSingleItemByName的结果.
  




